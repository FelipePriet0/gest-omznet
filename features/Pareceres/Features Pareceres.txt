### **Pareceres: 

O que serÃ¡:**

Local em â€œEditar fichaâ€ onde ao clicar no CTA: â€œ+â€ que vocÃª verÃ¡ descrito abaixo, abrirÃ¡ um campo de digitaÃ§Ã£o para que os Analistas ou Gestores possam escrever as DecisÃµes de AnÃ¡lise daquela ficha. 

Em quais abas estarÃ£o: 

- Editar Ficha (Abaixo de: â€œEquipe ResponsÃ¡velâ€)
- Expanded Ficha: 
    - PF: â€œAbaixo de InformaÃ§Ãµes relevantesâ€ E â€œ**InformaÃ§Ãµes relevantes do MKâ€**
    - PJ: â€œ**InformaÃ§Ãµes relevantes do MKâ€** 

Todos ficarÃ£o realtime, hookando direto do Backend, atualizando nas 3 pontas (Editar ficha / Expanded Ficha) conforme as Ãºltimas alteraÃ§Ãµes na coluna respectiva do mesmo. 

Ou seja, se eu alterar criar um novo parecer (AdiÃ§Ã£o) em Expanded Ficha ele vai jogar esse Input na respectiva coluna (public.kanban_cards.reanalysis_notes (array/json)) e na outra ponta (Onde consta esse Campo: Editar ficha, na qual vai puxar AO VIVO a informaÃ§Ã£o. Pois a tabela estarÃ¡ em Realtime.  

**Estrutura:** 

Pareceres  | CTA: â€œ+â€ 

**Function do CTA: â€œ+â€** 

- Abre um campo de digitaÃ§Ã£o abaixo de â€œPareceresâ€
- Colaboradores (Analistas e Gestores) digitam o parecer dentro do campo

- Ao confirmar (Entender): 

    - Salva no histÃ³rico de pareceres da ficha (com autor e horÃ¡rio). 
   -  Atualiza em tempo real para quem estiver com a ficha aberta.  
   - Se usar menÃ§Ãµes (@Nome), os mencionados recebem notificaÃ§Ã£o (quando correspondem a um perfil).  
        

<aside>
ğŸ’¡

Hook Realtime de salvamento: 
 
Campo: Parecer â€”Hookâ€”> public.kanban_cards.reanalysis_notes (array/json)

Cada parecer Ã© um item de uma lista no campo kanban_cards.reanalysis_notes (array/JSON). NÃ£o sobrescrevemos o anterior; o novo Ã© acrescentado Ã  lista.

- O que fica salvo (por parecer):
    - id: identificador Ãºnico do parecer
    - text: conteÃºdo do parecer
    - author_id, author_name, author_role: autor
    - created_at: data/hora de criaÃ§Ã£o
    - EdiÃ§Ã£o (se houver): updated_by_id, updated_by_name, updated_at
    - Encadeamento (se for resposta): parent_id, level, thread_id, is_thread_starter
    - Softâ€‘delete (se usado): deleted (boolean)
- Resultado: quando hÃ¡ 2+ pareceres, todos os anteriores permanecem nessa lista com seus metadados; o sistema
apenas agrega o novo como mais um item (e, em caso de ediÃ§Ã£o, atualiza os campos de â€œupdated_*â€ daquele item)
</aside>

<aside>
ğŸ’¡

FunÃ§Ãµes (RPC) para manipular pareceres

- PadrÃ£o do item (note) no array:
    - id: uuid
    - text: text
    - author_id: uuid
    - author_name: text
    - author_role: text (opcional)
    - created_at: timestamptz
    - updated_by_id, updated_by_name, updated_at (opcionais, sÃ³ quando editar)
    - parent_id, level, thread_id, is_thread_starter (opcionais, quando encadeado)
    - deleted (boolean, opcional)

[SQLs para qualquer dÃºvida](https://www.notion.so/SQLs-para-qualquer-d-vida-299770a00d18811b946cd4ea40e70e67?pvs=21)

</aside>

**FunÃ§Ãµes Internas do campo:** 

- /Aprovado â†’ Ao confirmar com Enter: Envia card para coluna: â€œAprovadosâ€
- /Negado â†’ Ao confirmar com Enter: Envia card para coluna: â€œNegadosâ€
- /Reanalise â†’ Ao confirmar com Enter: Envia card para coluna: â€œReanaliseâ€
- @ Para mencionar colaboradores. (Dispara notificaÃ§Ã£o para colaborador Mencionado)
- CTA: â€œâ†’â€ (Action: aÃ§Ã£o para responder diretamente a um parecer existente, criando uma conversa encadeada (thread) ligada Ã quele parecer.

<aside>
ğŸ’¡

O que acontece ao clicar

- Abre um campo de texto logo abaixo do parecer selecionado. Podendo nele: @mencionar e Direcionar com CTAs em Barra.
- VocÃª escreve a resposta e confirma.
- A resposta aparece â€œembaixoâ€ do parecer original, com os metadados de um parecer normal.
- |_> Aparece uma seta que liga o parecer respondido e o novo parecer para deixar visualmente ligados, como se fosse uma resposta mesmo

Assim como conversas co-relacionadas. PorÃ©m, no local de pareceres.
</aside>

- 3 Pontinhos (Canto superior, com CTAs: â€œEditarâ€ e â€œExcluirâ€)

- Editar: Abre o campo de digitaÃ§Ã£o cujo CTA estÃ¡ incluso, permitindo editar a escrita do Campo
- Excluir: 
    1  - Abre modal de confirmaÃ§Ã£o: 

          **Excluir Parecer
          Tem certeza que deseja excluir este parecer? Esta aÃ§Ã£o nÃ£o pode ser desfeita. 
           CTA: â€œCancelarâ€  (Cinza) | â€œExcluirâ€ (Vermelho)

Ao excluir:**

**Como o Sistema Registra:** 

- Armazena no campo de pareceres da ficha (lista de notas),  e na tabela.coluna: public.kanban_cards.reanalysis_notes (array/json) a ordem e a autoria.
- Adiciona metadados: autor, data/hora, nÃ­vel/thread quando for uma resposta encadeada (se aplicÃ¡vel).
- MantÃ©m os pareceres anteriores (nada Ã© sobrescrito; Ã© sempre â€œacrÃ©scimoâ€).

**RLS:** 

- Analistas e Gestores podem: Editar e deletar os prÃ³prios pareceres e responder pareceres de outros. 
- Vendedores: Apenas visualizam