Essas sÃ£o as features comum dos Kanbans, aquelas que constarÃ£o tanto no Kanban Comercial quanto no Kanban AnÃ¡lise. 

### 2.1 Estrutura do Card nas colunas:

O sistema de cards do Kanban Ã© o nÃºcleo da aplicaÃ§Ã£o, onde fichas comerciais sÃ£o organizadas em colunas por status e Ã¡rea. Cada card representa um cliente (PF ou PJ) em diferentes estÃ¡gios do processo comercial e de anÃ¡lise.

Campos que quero trazer para o Card visto no Kanban (Fazendo Realtime com Banco e  nÃ£o puxando do Front): 

- Nome ou RazÃ£o Social â€”Hook â€”> public.applicants.primary_name
- cpf ou CNPJ â€”Hook â€”> public.applicants.**cpf_cnpj**
- Tel â€”Hook â€”> public.applicants.phone
- Whatsapp â€”Hook â€”> public.applicants.**whatsapp**
- Data Agendamento  â€”Hook â€”> public.kanban_cards.**due_at**
- HorÃ¡rio de Agendamento    â€”Hook â€”> public.kanban_cards.hora_at
- Bairro  â€”Hook â€”> public.applicants.**bairro**

### Estrutura Visual:

Nome (Maior e superior)
CPF 
PHONE | WHATSAPP
DATA DE AGENDAMENTO | HORÃRIO 
BAIRRO

Campo superior direito: â€œIcone de Lixeiraâ€ na cor vermelha, puxando fluxo de ExclusÃ£o. 

Fluxo de exclusÃ£o de um Card no Kanban: 

**Primeira Etapa - ConfirmaÃ§Ã£o Inicial** 

```tsx
Modal: "Deletar Ficha"
â”œâ”€â”€ Mostra dados do cliente (Nome + CPF)
â”œâ”€â”€ Aviso: "A ficha serÃ¡ movida para o histÃ³rico de fichas excluÃ­das"
â”œâ”€â”€ BotÃ£o "Cancelar" (cinza)
â””â”€â”€ BotÃ£o "Sim, Deletar" (vermelho, corner radius 30px)
```

Â **Segunda Etapa -Â ConfirmaÃ§Ã£o Final**

```tsx
Modal: "ConfirmaÃ§Ã£o Final"
â”œâ”€â”€ Aviso: "Tem certeza que deseja apagar esta ficha?"
â”œâ”€â”€ DescriÃ§Ã£o: "Esta aÃ§Ã£o nÃ£o pode ser desfeita..."
â”œâ”€â”€ Campo de motivo (opcional) - texto verde
â”œâ”€â”€ BotÃ£o "Cancelar" (cinza)
â””â”€â”€ BotÃ£o "Confirmar ExclusÃ£o" (vermelho)
```

OBS: ExclusÃ£o de Cards entram no Soft Delete, permanecendo no Back end: Deletion Log por 90 dias, podendo reverter a situaÃ§Ã£o atravÃ©s do DB. 

**ğŸ›¡ï¸ SeguranÃ§a e ValidaÃ§Ã£o (RLS): 

- Apenas quem criou pode deletar.** 

### 2.1.1 Abrir ficha

O que Ã©: AÃ§Ã£o de abrir o Card para â€œEditar Fichaâ€
Como funciona: Ao clicar em Cima do Card, abre modal de â€œEditar fichaâ€. 

### 2.1.2 Grab + MovimentaÃ§Ã£o entre cards (Â **Sistema de Drag & Drop e MovimentaÃ§Ãµes entre Colunas)**

O sistema de drag & drop permitirÃ¡ que usuÃ¡rios movam cards entre colunas do Kanban de forma intuitiva, com atualizaÃ§Ã£o em tempo real, fallback para conexÃµes instÃ¡veis e validaÃ§Ãµes de fluxo de negÃ³cio.

**Interface de DragÂ & Drop 

1ï¸âƒ£ Iniciar o Drag**

<aside>
ğŸ’¡

UsuÃ¡rio â†’ Clica e arrasta o card â†’ Feedback visual ativado

</aside>

**Estados Visuais**

- **Cursor**:Â cursor-grabbingÂ duranteÂ o drag
- **TransformaÃ§Ã£o**:Â rotate(5deg)Â +Â opacity: 0.8
- **Sombra**:Â box-shadow: 0 10pxÂ 20px rgba(0,0,0,0.3)
- **Z-index**:Â 1000Â para ficarÂ acima de tudo

**2ï¸âƒ£ Durante o Drag**

<aside>
ğŸ’¡

Card sendo arrastado â†’ Placeholder fantasma na coluna de destino

</aside>

Lembrando que:

- Colunas: â€œCanceladasâ€ requisita motivo (Ativa fluxo como descrito anteriormente)
- Coluna: â€œEntradaâ€ nÃ£o permite nenhuma movimentaÃ§Ã£o para dentro
- Coluna: â€œConcluÃ­dasâ€ envia card para kanban anÃ¡lise: â€œRecebidoâ€;

## Para o back, precisamos fazer apenas:  Â **RPC Function:Â change_stage**

**O que faz**

:

- âœ… Valida parÃ¢metros de Ã¡rea e estÃ¡gio
- âœ… AtualizaÂ areaÂ eÂ stageÂ do card
- âœ… AtualizaÂ updated_at
    
    

### **2.1.3 - SistemaÂ de ExclusÃ£o de Cards no Kanban**

**VisÃ£o Geral:** 

OÂ sistema de exclusÃ£o de cards no Kanban utilizaÂ **Soft Delete**, uma abordagem que preservaÂ os dados no banco de dados enquanto remove o card da interfaceÂ do usuÃ¡rio. Isso garante auditoria completa e possibilidade de recuperaÃ§Ã£o.

**ğŸ”„Â Fluxo Completo de ExclusÃ£o**

**1ï¸âƒ£ Iniciar ExclusÃ£o** 

<aside>
ğŸ’¡

UsuÃ¡rio â†’ Card â†’ Menu (â‹®) â†’ + â€œMover +  "Deletarâ€ 

</aside>

# 2.1.3.1. ExclusÃ£o â€œDeletarâ€

**LocalizaÃ§Ã£o**: Menu dropdown no canto superior direito de cada card

**2ï¸âƒ£Â Primeira Etapa - ConfirmaÃ§Ã£o**

<aside>
ğŸ’¡

Modal: "Deletar Ficha"
â”œâ”€â”€ Mostra dados do cliente (Nome, CPF)
â”œâ”€â”€ Aviso: "A ficha serÃ¡ movida para o histÃ³rico de exclusÃµes"
â”œâ”€â”€ BotÃ£o "Cancelar" (cinza)
â””â”€â”€ BotÃ£o "Sim, Deletar" (vermelho, bordas arredondadas)

</aside>

**3ï¸âƒ£ SegundaÂ Etapa - Motivo** 

<aside>
ğŸ’¡

Modal: "ConfirmaÃ§Ã£o Final"
â”œâ”€â”€ Aviso: "Esta aÃ§Ã£o nÃ£o pode ser desfeita"
â”œâ”€â”€ Campo de motivo (opcional)
â”œâ”€â”€ BotÃ£o "Cancelar" (cinza)
â””â”€â”€ BotÃ£o "Confirmar ExclusÃ£o" (vermelho)

</aside>

**ğŸ”Â O que Acontece com os Dados**

**1ï¸âƒ£ No BancoÂ de Dados deverÃ¡ ficar:** 

<aside>
ğŸ’¡

- - ANTES da exclusÃ£o
SELECT id, title, cpf_cnpj, deleted_at, deleted_by, deletion_reason
FROM kanban_cards
WHERE id = 'card-id';
-- Resultado: deleted_at = NULL (card ativo)
- - DEPOIS da exclusÃ£o

SELECT id, title, cpf_cnpj, deleted_at, deleted_by, deletion_reason
FROM kanban_cards
WHERE id = 'card-id';
-- Resultado: deleted_at = '2024-01-15 14:30:00', deleted_by = 'user-id', deletion_reason = 'Motivo'

</aside>

**2ï¸âƒ£ Na Interface (Front):** 

<aside>
ğŸ’¡

// ANTES: Card aparece no Kanban
const cards = [
{ id: 'card-1', nome: 'JoÃ£o Silva', ... },
{ id: 'card-2', nome: 'Maria Santos', ... }
];

// DEPOIS: Card removido da lista
const cards = [
{ id: 'card-2', nome: 'Maria Santos', ... }
// card-1 nÃ£o aparece mais
];

</aside>

## Tabela / Colunas:

| **Tabela** | **Colunas de Soft Delete** | **O queÂ Armazenam** |
| --- | --- | --- |
| **kanban_cards** | deleted_at | Data/horaÂ da exclusÃ£o |
|  | deleted_by | ID do usuÃ¡rio que deletou |
|  | deletion_reason | Motivo informado pelo usuÃ¡rio |

## **MapeamentoÂ Direto:**

| **Frontend (JavaScript)** | **Backend (PostgreSQL)** | **Tipo** |
| --- | --- | --- |
| new Date().toISOString() | deleted_at | TIMESTAMPTZ |
| profile?.id | deleted_by | UUID |
| reason | deletion_reason | TEXT |

**"OÂ botÃ£o de deletar no frontend faz um UPDATE direto naÂ tabelaÂ kanban_cards, preenchendo as 3 colunas de soft delete:Â deleted_at,Â deleted_byÂ eÂ deletion_reason. NÃ£o hÃ¡ tabelas intermediÃ¡rias ou funÃ§Ãµes complexas - Ã© um hook direto entre o campoÂ do frontend e as colunas do backend."**

## RLS:

- O Ãºnico que pode excluir um Card Ã© o Autor do mesmo

# 2.1.3.2. Mover:

**ğŸ”„Â Fluxo Completo do modal: â€œMoverâ€**

**1ï¸âƒ£ Iniciar** 

<aside>
ğŸ’¡

UsuÃ¡rio â†’ Card â†’ Menu (â‹®) â†’ + â€œMover +  "Deletarâ€ 

</aside>

### O que abre:

- Modal na tela com dois campos:  
    
     Kanban (Dropdown: Comercial / AnÃ¡lise)

- Colunas (Ferente a escolha do Dropdown passado): 

Colunas (Dropdown)

  - Comercial: Feitas / Cadastrar no MK ; Aguardando documenttos ;  Canceladas (ABRIR MODAL DE CONFIRMAÃ‡ÃƒO)  (Concluidas nÃ£o aparece, uma vez que joga para o kanban AnÃ¡lise). 

  - AnÃ¡lise: â€œRecebidosâ€ ; â€œEm anÃ¡liseâ€ ; â€œReanÃ¡liseâ€ ; â€œAprovadosâ€ ; â€œNegadosâ€ ; â€œCanceladasâ€ (ABRIR MODAL DE CONFIRMAÃ‡ÃƒO)  ; â€œAss Appâ€ ; â€œFinalizadasâ€.

Somos first backend entÃ£o quero que essa funcionalidade acompanhe as mesmas regras / triggers que a movimentaÃ§Ã£o de cards com grab usa no Back. 

Obs: Essa func sÃ³ vai existir para poder migrar cards de AnÃ¡lise â†’ Comercial, caso alguem tenha movido errado, poderÃ¡ reverter por aqui. 

VAMOS PLANEJAR ANTES DE FAZÃŠ-LA PARA SER FIRST BACKEND. 

## **ğŸ’¾** 2.1.4  **Auto-save de Fichas - Sistema Completo**

## **VisÃ£o Geral**

O sistema deÂ auto-save salva automaticamente osÂ dados das fichas conformeÂ o usuÃ¡rio digita, evitandoÂ perda de informaÃ§Ãµes e melhorando a experiÃªncia doÂ usuÃ¡rio.

**O que acontece**

:

- âœ…Â **UsuÃ¡rio digita**Â â†’ Sistema detectaÂ mudanÃ§a
- âœ…Â **TimerÂ de 700ms**Â â†’ Aguarda parar de digitar
- âœ…Â **Auto-save**Â â†’ SalvaÂ automaticamente no banco
- âœ…Â **Repete**Â â†’Â Para cada novaÂ mudanÃ§a
- âœ…Â **Realtime â†’ Garante o Auto-save**

**ğŸ¯Â Fluxo Completo de Auto-save**

**1ï¸âƒ£ UsuÃ¡rio Digita** 

<aside>
ğŸ’¡

UsuÃ¡rio â†’ Digita no campo â†’ Sistema detecta mudanÃ§a

</aside>

**2ï¸âƒ£ Timer de Espera** 

<aside>
ğŸ’¡

Sistema â†’ Aguarda 700ms â†’ UsuÃ¡rio para de digitar?

</aside>

**3ï¸âƒ£ ExecuÃ§Ã£o do Auto-save**

<aside>
ğŸ’¡

Sistema â†’ flushAutosave() â†’ Salva no banc

</aside>

**4ï¸âƒ£ ConfirmaÃ§Ã£o**

<aside>
ğŸ’¡

Banco â†’ Dados salvos â†’ UsuÃ¡rio continua digitando

</aside>

Â **Estrutura TÃ©cnica** 

**1ï¸âƒ£ FunÃ§Ã£o Principal:Â flushAutosave â†’ Devemos criar?? AjudarÃ¡??** 

**2ï¸âƒ£ Debounce (Evitar Salvamentos Excessivos) - 700ms**

**Por que 700ms?**

- âœ…Â **NÃ£o muito rÃ¡pido**Â â†’ Evita spam no banco
- âœ…Â **NÃ£o muito lento**Â â†’ UsuÃ¡rio nÃ£o perdeÂ dados
- âœ…Â **EquilÃ­brio perfeito**Â â†’ Salva quando para de digitar

## **ğŸ“ŠÂ Tabelas Afetadas pelo Auto-save**

**1ï¸âƒ£ Tabela Principal:Â applicants**

**2ï¸âƒ£ Tabela de Teste:Â pf_fichas**

3ï¸âƒ£ **Tabela de Teste:Â pj_fichas**

## 2.1.5 **ğŸ”¥Â Sistema "Foguinho" - Indicador de UrgÃªncia**

## **ğŸ“‹Â VisÃ£o Geral**

O "Foguinho" Ã© um sistema visual que indica fichas emÂ situaÃ§Ã£o de urgÃªncia, comÂ animaÃ§Ãµes deÂ fogo e efeitos visuais para chamar atenÃ§Ã£o imediata.

## **ğŸ¯Â Quando o FoguinhoÂ Aparece**

## **1ï¸âƒ£ CondiÃ§Ãµes para Ativar**

**O foguinho aparece quando:** 

- âœ…Â **Card estÃ¡Â em colunas especÃ­ficas**:Â recebido,Â em_analise,Â reanalise,Â aprovado
- âœ…Â **PrazoÂ prÃ³ximo**: RestamÂ **24 horas ou menos**Â para o deadline
- âœ…Â **Prazo ainda vÃ¡lido**: NÃ£o passou do prazoÂ (msUntil >= 0)

## **2ï¸âƒ£Â LÃ³gica Inteligente de NegÃ³cio**

## **Como o Sistema Decide Quando Mostrar o Foguinho**

O sistema de "Foguinho" nÃ£o Ã© apenas um efeitoÂ visual bonitoÂ - ele segue umaÂ **lÃ³gica de negÃ³cio especÃ­fica**Â que determina quando uma ficha realmente precisa de atenÃ§Ã£o urgente.O sistemaÂ nÃ£o conta simplesmente 24 horas corridas.Â Ele considera apenas oÂ **horÃ¡rio de funcionamento da empresa**:
 

- **PrazosÂ por Coluna**

| **Coluna** | **Prazo Limite** | **Quando Aparece Foguinho** | **funcionamento da empresa** |
| --- | --- | --- | --- |
| recebido | 12h | Ãšltimas 12h do prazo | SegÂ a Sex 8h â†’  18h
Sabado: 8h â†’ 12h  |
| em_analise | 12h | Ãšltimas 12h do prazo | SegÂ a Sex 8h â†’  18h
Sabado: 8h â†’ 12h  |
| reanalise | 12h | Ãšltimas 12h do prazo | SegÂ a Sex 8h â†’  18h
Sabado: 8h â†’ 12h  |
| Ass App | 5h  | Ãšltimas 5h do prazo | SegÂ a Sex 8h â†’  18h
Sabado: 8h â†’ 12h  |

Sendo assim, as 12 e 5h de prazo (Lidas em: public.kanban_card.applicant_id + due_at + hora_at) sÃ³ conta as horas de funcionamento da empresa. 

Ou seja, domingo nÃ£o estÃ¡ na conta. Dia de semana apÃ³s as 18:00 tambÃ©m nÃ£o. 

**ğŸ”¥Â AnimaÃ§Ãµes do Foguinho 

1ï¸âƒ£ AnimaÃ§Ã£o Principal: Icon Fire: 

  - Icone de foguinho no canto superior direito, lado esquerdo dos 3 pontinhos (Mover / Deletear) 

2ï¸âƒ£ Efeito de Chamas:

 - Card em chamas. 

Vamos fazer essa parte em flutter para deixar mais animado e bonito.** 

### **ğŸ¯Â Estados do Foguinho**

**1ï¸âƒ£ EstadoÂ Normal**

<aside>
ğŸ’¡

Card sem urgÃªncia â†’ Sem efeitos visuais

</aside>

**2ï¸âƒ£ Estado "Pegando Fogoâ€**

<aside>
ğŸ’¡

Card com urgÃªncia â†’ Foguinho ativo com animaÃ§Ãµes (UrgÃªncia, segue tabela abaixo)

</aside>

Como puxa o prazo?? 

- public.kanban_card.applicants_id  + public.kanban_card.due_at + public.kanban_card.hora_at