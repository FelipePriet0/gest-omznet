# **ğŸ“‹Â Funcionalidade Tarefas**

## **ğŸ¯Â O que Ã©**

SerÃ¡ uma funcionalidade que permite que colaboradores atribuamÂ tarefas uns aos outros dentroÂ do contextoÂ de fichas comerciais. Ã‰ umaÂ ferramenta de gestÃ£o de atividades queÂ conecta conversas, anexos e o fluxo deÂ trabalho doÂ Kanban.

### Como chamar funÃ§Ã£o:

Digitar â€œ/tarefaâ€ nos campos de digitaÃ§Ã£o cujo CTA estÃ¡ ativo (Descritos abaixo):

### **ğŸ“Â OndeÂ aparecerÃ¡**

1. Em todos Campos parecer (Seja o primeiro (Pai) ou Resposta ou Sub-resposta) (Dentro de Editar ficha e Expanded Ficha)
2. Em todos Campos de conversas Co-relacionadas (Seja Trhead (PAI), Resposta (ComentÃ¡rio) OU sub-resposta (ComentÃ¡rio). 

**ğŸš€Â O que abre**

Modal central: **"Adicionar Tarefa"** 

Quando chamado por â€œ/tarefasâ€, nos campos cujo CTA estÃ¡ ativo, abre umÂ **drawerÂ lateral**Â (Sheet) com:

### **Header (CabeÃ§alho)**

- **TÃ­tulo**: "Adicionar Tarefa" ou "Editar Tarefa"
- **DescriÃ§Ã£o**:Â "Crie uma nova tarefa paraÂ a equipe"
- **Design**: Gradiente verde com fundo moderno

### **SeÃ§Ã£o 1: AtribuiÃ§Ã£o da Tarefa**

- **Campo "De"**:
- Nome do usuÃ¡rio atual (auto-preenchido pelo Autor (Colaborador) que estÃ¡ criando a tarefa
- NÃ£o editÃ¡vel
- Fundo cinza para indicar desabilitado

- **Campo "Para"**:
- Dropdown com lista de colaboradores
- Mostra nome + cargoÂ (ex: "JoÃ£o Silva Â· Analista")
- Indicador de quantosÂ colaboradores disponÃ­veis

### **SeÃ§Ã£o 2: DescriÃ§Ã£o da Tarefa**

- **Campo de texto**:
- Placeholder:Â "Ex.: ReagendarÂ instalaÃ§Ã£oÂ para o dia 12/10 Ã s 14h."
- 4 linhas de altura
- ValidaÃ§Ã£o obrigatÃ³ria

### **SeÃ§Ã£o 3: Prazo**

- **Campo deÂ data/hora**:
- Opcional
- Formato: datetime-local
- Mostra preview da data selecionada

### **BotÃµes deÂ AÃ§Ã£o**

- **"Cancelar"**Â (cinza): Fecha oÂ drawer
- **"Criar Tarefa"**Â (verde): Confirma criaÃ§Ã£o

**ğŸ¨Â Estrutura Desenhada do Modal**

```tsx
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸŸ¢ Header - Gradiente Verde         â”‚
â”‚ "Adicionar Tarefa"                  â”‚
â”‚ "Crie uma nova tarefa para a equipe" â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ”µ SeÃ§Ã£o: AtribuiÃ§Ã£o                â”‚
â”‚ De: [JoÃ£o Silva] (cinza)            â”‚
â”‚ Para: [Dropdown â–¼]                  â”‚
â”‚ â— 3 colaborador(es) disponÃ­vel(is)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸŸ¢ SeÃ§Ã£o: DescriÃ§Ã£o                 â”‚
â”‚ [Campo de texto 4 linhas]           â”‚
â”‚ "Seja claro e especÃ­fico..."        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸŸ£ SeÃ§Ã£o: Prazo                     â”‚
â”‚ [Data/Hora] (Opcional)              â”‚
â”‚ â— Prazo definido para 12/10/2024    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Cancelar] [Criar Tarefa]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## **ğŸ’¾Â O que gera (Ao â€œCriar Tarefaâ€)**

**Tabela:Â card_tasks**

Quando uma tarefaÂ Ã© criada, o sistema: 

1. **Insere registro**Â na tabelaÂ card_tasks 
2. **Cria comentÃ¡rio**Â na conversaÂ encadeada OU no parecer (Onde for chamado a funÃ§Ã£o â€œ/tarefaâ€)
3. **Envia notificaÃ§Ã£o**Â para o usuÃ¡rio atribuÃ­do 
4. **Atualiza interface**Â emÂ tempo real

### **ğŸ¯Â FeaturesÂ do Campo Visual (Tarefa Criada)**

**Dentro das Conversas Co-relacionadas e Pareceres (Seja Trhead (Pai) OU ComentÃ¡rios (Resposta) OU Sub-Resposta (ComentÃ¡rios)** 

A tarefa aparece como umaÂ **mensagem especial**Â com a seguinte estrutura: 

1. Canto Superior: Data de criaÃ§Ã£o /  Nome de quem Criou + Cargo (Ex: 22/10 11:20 Felipe Prieto (Gestor) +  
2. Card da tarefa: 
- Checkbox (Para marcaÃ§Ã£o: Pendente / ConcluÃ­da)  + â€œTarefaâ€
Para: â€œ@Colaboradorâ€ selecionado dentro do modal no campo: â€œParaâ€
DescriÃ§Ã£o: â€œTexto descrito no campo: â€œDescreva a tarefaâ€ dentro do modal
Prazo: Acompanha â€œData e horaâ€ selecionada no campo â€œPrazoâ€ dentro do Modal. 

**VisualÂ da Tarefa**

```tsx
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â˜ [Checkbox] ğŸ“‹ Tarefa Criada      |
â”‚                                     â”‚
â”‚ ğŸ‘¤ Para: @JoÃ£o Silva                â”‚
â”‚ ğŸ“ DescriÃ§Ã£o: Reagendar instalaÃ§Ã£o  â”‚
â”‚ â° Prazo: 12/10/2024 Ã s 14h                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- Checkbox (Campo (Checkbox) de marcaÃ§Ã£o para tarefas Pendentes e Concluidas.

- Quando clicado: Mudar cor do card da tarefa para verde, riscar as linhas e marcar o Checkbox com um â€œVâ€ de â€œCheckâ€. Modele a funcionalidade â€œ/Tarefasâ€ do Notion e vamos fazer igual.

## **ğŸ“ŠÂ Indicadores Visuais**

### **Status daÂ Tarefa**

- **ğŸŸ¡ Pendente**: Checkbox vazio, fundo azul
- **ğŸŸ¢ ConcluÃ­da**: Checkbox marcado, fundo verde, texto riscado
- **ğŸ”´ Atrasada**: Fundo vermelho, Ã­cone de alerta

- **Clique na tarefa**: Abre modal da TAREFA, com todas as informaÃ§Ãµes preenchidas (Realtime), dando opÃ§Ã£o do Colaborador que criou, editar a tarefa.

### Regra:

- Tarefas que vem/sÃ£o chamadas no campo de conversas co-relacionadas (Trheads e comentÃ¡rios) (Tem os CTAs de responder + Excluir) da prÃ³pria conversa co-relacionada. Ou seja, a funcionalidade â€œTarefaâ€ , quando criada, aparece dentro da conversa co-relacionada, herdando dessa funcionalidade as Actions de: Responder e Excluir. 

â€Editar, vem de clicar em cima da tarefa, fazendo abrir o Modal novamente, com as informaÃ§Ãµes preenchidas e dando abertura para o criador da tarefa alterar os campos (Todos os Campos).
- Tarefas que vem/sÃ£o chamadas no campo Parecer (Em editar ficha ou Expanded Ficha) (Tem os CTAs de responder + Excluir), herdados do prÃ³prio parecer.

â€Editar, vem de clicar em cima da tarefa, fazendo abrir o Modal novamente, com as informaÃ§Ãµes preenchidas e dando abertura para o criador da tarefa alterar os campos (Todos os Campos). 

Lembrando que: Devemos apagar do Banco ao â€œExcluirâ€ uma tarefa, seguindo â€œHard Deleteâ€.

Â **TabelaÂ da Funcionalidade**

- **Tabela:Â card_tasks**

| Coluna | Tipo | DescriÃ§Ã£o |
| --- | --- | --- |
| id | UUID | Identificador Ãºnico daÂ tarefa |
| card_id | UUID | ID do card relacionadoÂ (FK) |
| card_title | TEXT | Nome da ficha (denormalizado) |
| created_by | UUID | IDÂ do usuÃ¡rio que criou (FK) |
| assigned_to | UUID | ID do usuÃ¡rio responsÃ¡velÂ (FK) |
| description | TEXT | DescriÃ§Ã£o da tarefa |
| status | TEXT | 'pending' ou 'completed' |
| deadline | TIMESTAMPTZ | Prazo para conclusÃ£o |
| comment_id | UUID | ID do comentÃ¡rio associado (FK) |
| created_at | TIMESTAMPTZ | Data deÂ criaÃ§Ã£o |
| updated_at | TIMESTAMPTZ | Data da ÃºltimaÂ atualizaÃ§Ã£o |
| completed_at | TIMESTAMPTZ | DataÂ de conclusÃ£o |

## **ğŸ”—Â Foreign Keys (FKs)**

**ConexÃµes da TabelaÂ card_tasks**

| Coluna | Referencia | Tabela | AÃ§Ã£o |
| --- | --- | --- | --- |
| card_id | kanban_cards.id | kanban_cards | CASCADE (deleta tarefa seÂ card for deletado) |
| created_by | profiles.id | profiles | CASCADE (deleta tarefa se usuÃ¡rio for deletado) |
| assigned_to | profiles.id | profiles | CASCADE (deleta tarefaÂ se usuÃ¡rio for deletado) |
| comment_id | card_comments.id | card_comments | SET NULL (mantÃ©m tarefa se comentÃ¡rioÂ for deletado) |

## **ğŸ›¡ï¸Â PolÃ­ticasÂ de SeguranÃ§a (RLS)**

**PermissÃµes daÂ TabelaÂ card_tasks**

| AÃ§Ã£o | Quem Pode | CondiÃ§Ã£o |
| --- | --- | --- |
| **SELECT** | Qualquer usuÃ¡rio autenticado | - |
| **INSERT** | Qualquer usuÃ¡rio autenticado | Pode criar tarefa para siÂ mesmo |
| **UPDATE** | Qualquer usuÃ¡rioÂ autenticado | - |
| **DELETE** | ApenasÂ quem criouÂ a tarefa | auth.uid() = created_by |
| EDIT  | Apenas quem criou a tarefa | auth.uid() = created_by |

## **Funcionalidades que devem Hookar com o Backend :**

## **Checkbox de Status de Tarefa**

- Hookado com Coluna: public.card_tasks.status â†’ Se pressionado/marcado muda de Pending para completed. 
**Comportamento**:
**Marcado**Â â†’Â status = 'completed' â†’ **ğŸŸ¢ ConcluÃ­da**: Checkbox marcado, fundo verde, texto riscado 
**Desmarcado**Â â†’Â status = 'pending' â†’ **ğŸŸ¡ Pendente**: Checkbox vazio, fundo azul
**Trigger AutomÃ¡tico**: QuandoÂ statusÂ muda paraÂ 'completed', o campoÂ completed_atÂ Ã© preenchido automaticamente

### **Campo de DescriÃ§Ã£o**

- **Hook**:Â useTasksÂ â†’Â updateTask()
- **Coluna**:Â card_tasks.description
- **ValidaÃ§Ã£o**: Campo obrigatÃ³rio, mÃ­nimo 1 caractere

### **Campo "Para" (AtribuiÃ§Ã£o)**

- **Hook**:Â card_tasks.assigned_to
- **FK**: ReferenciaÂ profiles.id
- **ValidaÃ§Ã£o**: Deve ser um usuÃ¡rio vÃ¡lido do sistema

### **Campo de Prazo**

- **Hook**:Â card_tasks.deadline
- **Tipo**:Â TIMESTAMPTZ
- **Opcional**: Pode ser NULL

### **CriaÃ§Ã£o de Tarefa**

- **Hook**:Â **Colunas Abaixo Preenchidas Automaticamente**:
- created_byÂ â†’Â auth.uid()Â (usuÃ¡rio atual)
- card_titleÂ â†’ TÃ­tulo do card (trigger automÃ¡tico)
- created_atÂ â†’Â now()
- statusÂ â†’Â 'pending'Â (padrÃ£o)

### **NotificaÃ§Ãµes**

- **Trigger**: Quando tarefa Ã© criada
- **Tipo**:Â task_assigned
- **DestinatÃ¡rio**: UsuÃ¡rio emÂ assigned_to
- **ConteÃºdo**: "Nova tarefa: [descriÃ§Ã£o]"